<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥¿ç­ç‰™è¯­åŠ¨è¯å˜ä½å¤§å¸ˆ V1.1</title>
    <style>
        :root {
            --primary: #B71C1C; /* å­¦é™¢çº¢ */
            --primary-light: #FFCDD2;
            --secondary: #FFD600; /* äº®é»„ */
            --text: #212121;
            --text-light: #757575;
            --bg: #FAFAFA;
            --white: #FFFFFF;
            --hover-row: #FFF8E1;
            --border: #E0E0E0;
            --root-color: #000;
            --ending-color: #D32F2F; 
            --irreg-color: #1565C0; 
            --aux-color: #616161;   
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* å¯¼èˆª */
        nav {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
        }
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }
        .nav-title { font-size: 1.4rem; font-weight: bold; letter-spacing: 1px;}
        .nav-tabs { display: flex; gap: 5px; height: 100%; margin: 0; padding: 0; list-style: none;}
        .nav-item {
            padding: 0 15px;
            height: 100%;
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 500;
            transition: 0.2s;
            border-bottom: 4px solid transparent;
            opacity: 0.9;
            font-size: 0.95rem;
        }
        .nav-item:hover { background: rgba(255,255,255,0.1); opacity: 1; }
        .nav-item.active { border-bottom-color: var(--secondary); opacity: 1; background: rgba(255,255,255,0.15); }

        /* å¼€å…³æ ·å¼ */
        .toggle-wrapper { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; margin-left: 15px; background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 20px;}
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--secondary); }
        input:checked + .slider:before { transform: translateX(14px); }

        /* ä¸»ä½“ */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡ */
        .card {
            background: var(--white);
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            padding: 25px;
            margin-bottom: 25px;
            border-top: 3px solid transparent;
        }
        .card:hover { border-top-color: var(--secondary); }

        /* æ ‡é¢˜ç³»ç»Ÿ */
        h2 { margin: 0 0 20px 0; color: var(--primary); font-size: 1.5rem; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        h3 { 
            background: #eee; 
            padding: 10px 15px; 
            margin: 30px 0 15px 0; 
            border-radius: 4px; 
            color: #333; 
            font-size: 1.1rem; 
            border-left: 5px solid var(--primary);
        }
        .tense-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        
        /* å˜ä½è¡¨ */
        .table-wrapper { border: 1px solid #eee; border-radius: 4px; overflow: hidden; }
        .tense-name { 
            background: #f9f9f9; padding: 8px 12px; font-weight: bold; color: #555; 
            font-size: 0.9rem; border-bottom: 1px solid #eee; text-align: center;
        }
        .cj-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        .cj-table td { padding: 6px 12px; border-bottom: 1px solid #f5f5f5; }
        .cj-table tr:last-child td { border-bottom: none; }
        .cj-table tr:hover { background-color: var(--hover-row); }
        
        .pronoun { color: #aaa; width: 30%; font-size: 0.8rem; user-select: none;}
        .verb-form { color: var(--text); font-family: 'Georgia', serif; }
        
        /* é¢œè‰² */
        .root { color: var(--root-color); }
        .ending { color: var(--ending-color); font-weight: bold; }
        .irreg { color: var(--irreg-color); font-weight: bold; text-decoration: underline; text-decoration-color: rgba(21, 101, 192, 0.3); }
        .aux { color: var(--aux-color); font-size: 0.9em; }
        .part { color: var(--text); font-weight: bold; }

        /* é€‰æ‹©å™¨ */
        .verb-selector { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        .v-btn {
            background: #fff; border: 1px solid #ddd; padding: 6px 12px; border-radius: 15px;
            cursor: pointer; font-size: 0.9rem; color: #555; transition: all 0.2s;
        }
        .v-btn:hover { border-color: var(--primary); color: var(--primary); background: #fff5f5; }
        .v-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .group-label { font-size: 0.85rem; color: #888; margin: 10px 0 5px 0; display: block; text-transform: uppercase; font-weight: bold;}

        /* éäººç§° */
        .np-grid { display: flex; gap: 15px; flex-wrap: wrap; }
        .np-box { flex: 1; background: #e3f2fd; padding: 10px; border-radius: 4px; text-align: center; min-width: 120px; }
        .np-label { display: block; font-size: 0.8rem; color: #1565c0; margin-bottom: 5px; font-weight: bold;}
        .np-val { font-size: 1.2rem; font-weight: bold; }

        /* æµ‹è¯• & é”™é¢˜ */
        .quiz-box { max-width: 600px; margin: 20px auto; text-align: center; }
        .q-verb { font-size: 2.5rem; font-weight: bold; color: var(--primary); margin: 10px 0; }
        .q-meta { color: #666; margin-bottom: 20px; font-size: 1.1rem;}
        .q-input { 
            font-size: 1.5rem; padding: 10px; width: 80%; text-align: center; 
            border: 2px solid #ddd; border-radius: 8px; outline: none; transition: 0.3s;
        }
        .q-input:focus { border-color: var(--secondary); }
        .char-btn { background: #eee; border: none; padding: 8px 14px; margin: 2px; border-radius: 4px; cursor: pointer; font-size: 1rem;}
        .feedback { height: 30px; margin: 10px 0; font-weight: bold; font-size: 1.1rem;}
        .correct-msg { color: #2e7d32; }
        .wrong-msg { color: #c62828; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 10px 30px; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        
        .record-item { border-left: 4px solid #d32f2f; background: #fff; padding: 12px; margin-bottom: 8px; border-radius: 0 4px 4px 0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        .hint { font-size: 0.8rem; color: #888; margin-top: 5px; }

    </style>
</head>
<body>

<nav>
    <div class="nav-container">
        <div style="display:flex; align-items:center;">
            <div class="nav-title">ğŸ‡ªğŸ‡¸ Verb Master</div>
            <!-- æ‹‰ç¾æ¨¡å¼å¼€å…³ -->
            <div class="toggle-wrapper">
                <label class="switch">
                    <input type="checkbox" id="latam-toggle" onchange="toggleLatamMode()">
                    <span class="slider round"></span>
                </label>
                <span>Latam (æ— Vosotros)</span>
            </div>
        </div>

        <ul class="nav-tabs">
            <li class="nav-item active" onclick="setTab('learn', this)">æŸ¥è¯¢</li>
            <li class="nav-item" onclick="setTab('quiz', this)">æµ‹è¯•</li>
            <li class="nav-item" onclick="setTab('records', this)">é”™é¢˜</li>
        </ul>
    </div>
</nav>

<main>
    <!-- 1. å­¦ä¹ æ¨¡å— -->
    <div id="learn" class="section active">
        <div class="card">
            <span class="group-label">è§„åˆ™åŠ¨è¯ (Regulares)</span>
            <div class="verb-selector">
                <button class="v-btn active" onclick="loadVerb('hablar')">Hablar</button>
                <button class="v-btn" onclick="loadVerb('comer')">Comer</button>
                <button class="v-btn" onclick="loadVerb('vivir')">Vivir</button>
            </div>

            <span class="group-label">æœ‰è§„å¾‹ä¸è§„åˆ™</span>
            <div class="verb-selector">
                <button class="v-btn" onclick="loadVerb('pensar')">Pensar (e-ie)</button>
                <button class="v-btn" onclick="loadVerb('dormir')">Dormir (o-ue)</button>
                <button class="v-btn" onclick="loadVerb('poder')">Poder (o-ue)</button>
                <button class="v-btn" onclick="loadVerb('jugar')">Jugar (u-ue)</button>
                <button class="v-btn" onclick="loadVerb('pedir')">Pedir (e-i)</button>
                <button class="v-btn" onclick="loadVerb('hacer')">Hacer (Yo-Go)</button>
                <button class="v-btn" onclick="loadVerb('conocer')">Conocer (c-zc)</button>
            </div>

            <span class="group-label">å®Œå…¨ä¸è§„åˆ™</span>
            <div class="verb-selector">
                <button class="v-btn" onclick="loadVerb('ser')">Ser</button>
                <button class="v-btn" onclick="loadVerb('estar')">Estar</button>
                <button class="v-btn" onclick="loadVerb('ir')">Ir</button>
                <button class="v-btn" onclick="loadVerb('dar')">Dar</button>
                <button class="v-btn" onclick="loadVerb('haber')">Haber</button>
                <button class="v-btn" onclick="loadVerb('tener')">Tener</button>
                <button class="v-btn" onclick="loadVerb('decir')">Decir</button>
                <button class="v-btn" onclick="loadVerb('venir')">Venir</button>
            </div>
        </div>

        <div id="conjugation-display"></div>
    </div>

    <!-- 2. æµ‹è¯•æ¨¡å— -->
    <div id="quiz" class="section">
        <div class="card quiz-box">
            <h2 style="border:none; padding:0;">å˜ä½ç‰¹è®­</h2>
            <div id="q-meta" class="q-meta">åŠ è½½ä¸­...</div>
            <div id="q-verb" class="q-verb">...</div>
            
            <input type="text" id="q-input" class="q-input" placeholder="è¾“å…¥å˜ä½..." autocomplete="off">
            <div class="hint">ğŸ’¡ å¿«æ·é”®ï¼šè¾“å…¥ ' + a = Ã¡, ' + n = Ã±</div>
            <div id="q-feedback" class="feedback"></div>
            
            <div>
                <button class="btn-main" onclick="checkAnswer()">æäº¤ (Enter)</button>
                <button style="background:none; border:none; color:#999; cursor:pointer; margin-left:15px;" onclick="nextQuestion()">è·³è¿‡</button>
            </div>
            
            <div style="margin-top:20px;">
                <button class="char-btn" onclick="addChar('Ã¡')">Ã¡</button>
                <button class="char-btn" onclick="addChar('Ã©')">Ã©</button>
                <button class="char-btn" onclick="addChar('Ã­')">Ã­</button>
                <button class="char-btn" onclick="addChar('Ã³')">Ã³</button>
                <button class="char-btn" onclick="addChar('Ãº')">Ãº</button>
                <button class="char-btn" onclick="addChar('Ã±')">Ã±</button>
            </div>
        </div>
    </div>

    <!-- 3. é”™é¢˜æœ¬ -->
    <div id="records" class="section">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; border:none; padding:0;">é”™é¢˜è®°å½•</h2>
                <button class="v-btn" onclick="clearRecords()">æ¸…ç©ºè®°å½•</button>
            </div>
            <div id="records-list"></div>
        </div>
    </div>

</main>

<script>
/* ================= å…¨å±€çŠ¶æ€ ================= */
let isLatamMode = false;
let currentVerb = 'hablar'; // è®°ä½å½“å‰æŸ¥çœ‹çš„åŠ¨è¯

function toggleLatamMode() {
    isLatamMode = document.getElementById('latam-toggle').checked;
    // å¦‚æœå½“å‰åœ¨å­¦ä¹ é¡µï¼Œé‡æ–°æ¸²æŸ“è¡¨æ ¼
    if(document.getElementById('learn').classList.contains('active')) {
        renderDisplay(currentVerb);
    }
    // å¦‚æœå½“å‰åœ¨æµ‹è¯•é¡µï¼Œä¸éœ€è¦ç«‹å³åŠ¨ä½œï¼Œä½†åœ¨ä¸‹ä¸€é¢˜æ—¶ä¼šç”Ÿæ•ˆ
}

/* ================= æ ¸å¿ƒæ•°æ®å®šä¹‰ ================= */

const pronouns = ['Yo', 'TÃº', 'Ã‰l/Ella/Usted', 'Nosotros/as', 'Vosotros/as', 'Ellos/as/Ustedes'];

// 1. è§„åˆ™è¯å°¾
const regularEndings = {
    ar: {
        pres: ['o','as','a','amos','Ã¡is','an'],
        imp: ['aba','abas','aba','Ã¡bamos','abais','aban'],
        pret: ['Ã©','aste','Ã³','amos','asteis','aron'],
        fut: ['arÃ©','arÃ¡s','arÃ¡','aremos','arÃ©is','arÃ¡n'],
        cond: ['arÃ­a','arÃ­as','arÃ­a','arÃ­amos','arÃ­ais','arÃ­an'],
        sub_pres: ['e','es','e','emos','Ã©is','en'],
        sub_imp_ra: ['ara','aras','ara','Ã¡ramos','arais','aran'],
        sub_imp_se: ['ase','ases','ase','Ã¡semos','aseis','asen'],
        sub_fut: ['are','ares','are','Ã¡remos','areis','aren'],
        part: 'ado', ger: 'ando'
    },
    er: {
        pres: ['o','es','e','emos','Ã©is','en'],
        imp: ['Ã­a','Ã­as','Ã­a','Ã­amos','Ã­ais','Ã­an'],
        pret: ['Ã­','iste','iÃ³','imos','isteis','ieron'],
        fut: ['erÃ©','erÃ¡s','erÃ¡','eremos','erÃ©is','erÃ¡n'],
        cond: ['erÃ­a','erÃ­as','erÃ­a','erÃ­amos','erÃ­ais','erÃ­an'],
        sub_pres: ['a','as','a','amos','Ã¡is','an'],
        sub_imp_ra: ['iera','ieras','iera','iÃ©ramos','ierais','ieran'],
        sub_imp_se: ['iese','ieses','iese','iÃ©semos','ieseis','iesen'],
        sub_fut: ['iere','ieres','iere','iÃ©remos','iereis','ieren'],
        part: 'ido', ger: 'iendo'
    },
    ir: {
        pres: ['o','es','e','imos','Ã­s','en'],
        imp: ['Ã­a','Ã­as','Ã­a','Ã­amos','Ã­ais','Ã­an'],
        pret: ['Ã­','iste','iÃ³','imos','isteis','ieron'],
        fut: ['irÃ©','irÃ¡s','irÃ¡','iremos','irÃ©is','irÃ¡n'],
        cond: ['irÃ­a','irÃ­as','irÃ­a','irÃ­amos','irÃ­ais','irÃ­an'],
        sub_pres: ['a','as','a','amos','Ã¡is','an'],
        sub_imp_ra: ['iera','ieras','iera','iÃ©ramos','ierais','ieran'],
        sub_imp_se: ['iese','ieses','iese','iÃ©semos','ieseis','iesen'],
        sub_fut: ['iere','ieres','iere','iÃ©remos','iereis','ieren'],
        part: 'ido', ger: 'iendo'
    }
};

// 2. åŠ©åŠ¨è¯ Haber
const haberForms = {
    pres: ['he','has','ha','hemos','habÃ©is','han'],
    imp: ['habÃ­a','habÃ­as','habÃ­a','habÃ­amos','habÃ­ais','habÃ­an'],
    pret: ['hube','hubiste','hubo','hubimos','hubisteis','hubieron'],
    fut: ['habrÃ©','habrÃ¡s','habrÃ¡','habremos','habrÃ©is','habrÃ¡n'],
    cond: ['habrÃ­a','habrÃ­as','habrÃ­a','habrÃ­amos','habrÃ­ais','habrÃ­an'],
    sub_pres: ['haya','hayas','haya','hayamos','hayÃ¡is','hayan'],
    sub_imp_ra: ['hubiera','hubieras','hubiera','hubiÃ©ramos','hubierais','hubieran'],
    sub_imp_se: ['hubiese','hubieses','hubiese','hubiÃ©semos','hubieseis','hubiesen'],
    sub_fut: ['hubiere','hubieres','hubiere','hubiÃ©remos','hubiereis','hubieren']
};

// 3. åŠ¨è¯æ•°æ®åº“ (ä¿®å¤ï¼šè¡¥å……ç¼ºå¤±çš„å˜ä½ã€ä¿®æ­£ä¸è§„åˆ™åŠ¨è¯å®šä¹‰)
const verbsDB = {
    // è§„åˆ™
    hablar: { trans: 'è¯´', type: 'reg', end: 'ar' },
    comer: { trans: 'åƒ', type: 'reg', end: 'er' },
    vivir: { trans: 'ç”Ÿæ´»', type: 'reg', end: 'ir' },
    // è§„å¾‹ä¸è§„åˆ™
    pensar: { trans: 'æƒ³', type: 'stem', end: 'ar', rule: 'e-ie' },
    dormir: { trans: 'ç¡è§‰', type: 'stem', end: 'ir', rule: 'o-ue', ger: 'durmiendo' },
    poder: { trans: 'èƒ½å¤Ÿ', type: 'stem', end: 'er', rule: 'o-ue', strong_stem: 'pud', future_stem: 'podr', ger_stem: 'pud' },
    jugar: { trans: 'ç©', type: 'stem', end: 'ar', rule: 'u-ue', pret_yo: 'juguÃ©' },
    pedir: { trans: 'è¯·æ±‚', type: 'stem', end: 'ir', rule: 'e-i' },
    hacer: { 
        trans: 'åš', type: 'yoga', end: 'er', yo: 'hago', 
        strong_stem: 'hic', strong_stem_3: 'hiz', future_stem: 'har', 
        part: 'hecho',
        sub_pres: ['haga','hagas','haga','hagamos','hagÃ¡is','hagan'] // ä¿®å¤ï¼šè¡¥å……è™šæ‹Ÿå¼ç°åœ¨æ—¶
    },
    conocer: { trans: 'è®¤è¯†', type: 'yoga', end: 'er', yo: 'conozco' },
    // å®Œå…¨ä¸è§„åˆ™
    dar: { 
        trans: 'ç»™', type: 'total', end: 'ar', 
        forms: {
            pres: ['doy','das','da','damos','dais','dan'],
            imp: ['daba','dabas','daba','dÃ¡bamos','dabais','daban'],
            pret: ['di','diste','dio','dimos','disteis','dieron'],
            fut: ['darÃ©','darÃ¡s','darÃ¡','daremos','darÃ©is','darÃ¡n'],
            cond: ['darÃ­a','darÃ­as','darÃ­a','darÃ­amos','darÃ­ais','darÃ­an'],
            sub_pres: ['dÃ©','des','dÃ©','demos','deis','den'],
            sub_imp_ra: ['diera','dieras','diera','diÃ©ramos','dierais','dieran'],
            sub_imp_se: ['diese','dieses','diese','diÃ©semos','dieseis','diesen'],
            sub_fut: ['diere','dieres','diere','diÃ©remos','diereis','dieren'],
            imp_af: ['-','da','dÃ©','demos','dad','den']
        }
    },
    ser: { 
        trans: 'æ˜¯', type: 'total', end: 'er', 
        forms: {
            pres: ['soy','eres','es','somos','sois','son'],
            imp: ['era','eras','era','Ã©ramos','erais','eran'],
            pret: ['fui','fuiste','fue','fuimos','fuisteis','fueron'],
            fut: ['serÃ©','serÃ¡s','serÃ¡','seremos','serÃ©is','serÃ¡n'], // ä¿®å¤ï¼šè¡¥å……å°†æ¥æ—¶
            cond: ['serÃ­a','serÃ­as','serÃ­a','serÃ­amos','serÃ­ais','serÃ­an'], // ä¿®å¤ï¼šè¡¥å……æ¡ä»¶å¼
            sub_pres: ['sea','seas','sea','seamos','seÃ¡is','sean'],
            sub_imp_ra: ['fuera','fueras','fuera','fuÃ©ramos','fuerais','fueran'],
            sub_imp_se: ['fuese','fueses','fuese','fuÃ©semos','fueseis','fuesen'], // ä¿®å¤ï¼šè¡¥å……-seå½¢å¼
            sub_fut: ['fuere','fueres','fuere','fuÃ©remos','fuereis','fueren'], // ä¿®å¤ï¼šè¡¥å……å°†æ¥æ—¶
            imp_af: ['-','sÃ©','sea','seamos','sed','sean']
        }
    },
    ir: { 
        trans: 'å»', type: 'total', end: 'ir', ger: 'yendo', part: 'ido', // ä¿®å¤ï¼šè¡¥å……åˆ†è¯
        forms: {
            pres: ['voy','vas','va','vamos','vais','van'],
            imp: ['iba','ibas','iba','Ã­bamos','ibais','iban'],
            pret: ['fui','fuiste','fue','fuimos','fuisteis','fueron'],
            fut: ['irÃ©','irÃ¡s','irÃ¡','iremos','irÃ©is','irÃ¡n'], // ä¿®å¤ï¼šè¡¥å……å°†æ¥æ—¶
            cond: ['irÃ­a','irÃ­as','irÃ­a','irÃ­amos','irÃ­ais','irÃ­an'], // ä¿®å¤ï¼šè¡¥å……æ¡ä»¶å¼
            sub_pres: ['vaya','vayas','vaya','vayamos','vayÃ¡is','vayan'],
            sub_imp_ra: ['fuera','fueras','fuera','fuÃ©ramos','fuerais','fueran'],
            sub_imp_se: ['fuese','fueses','fuese','fuÃ©semos','fueseis','fuesen'], // ä¿®å¤ï¼šè¡¥å……-seå½¢å¼
            sub_fut: ['fuere','fueres','fuere','fuÃ©remos','fuereis','fueren'], // ä¿®å¤ï¼šè¡¥å……å°†æ¥æ—¶
            imp_af: ['-','ve','vaya','vayamos','id','vayan']
        }
    },
    tener: { 
        trans: 'æ‹¥æœ‰', type: 'yoga', end: 'er', yo: 'tengo', 
        strong_stem: 'tuv', future_stem: 'tendr', imp_af_tu: 'ten',
        sub_pres: ['tenga','tengas','tenga','tengamos','tengÃ¡is','tengan'] // ä¿®å¤ï¼šè¡¥å……è™šæ‹Ÿå¼ç°åœ¨æ—¶
    },
    estar: { 
        trans: 'åœ¨', type: 'yoga', end: 'ar', yo: 'estoy', 
        strong_stem: 'estuv', future_stem: 'estar', // ä¿®å¤ï¼šè¡¥å……å°†æ¥æ—¶stem
        sub_pres: ['estÃ©','estÃ©s','estÃ©','estemos','estÃ©is','estÃ©n'] 
    },
    haber: { 
        trans: 'æœ‰(è¾…åŠ©)', type: 'yoga', end: 'er', yo: 'he', 
        strong_stem: 'hub', future_stem: 'habr', 
        sub_pres: ['haya','hayas','haya','hayamos','hayÃ¡is','hayan'] 
    },
    decir: { 
        trans: 'è¯´', type: 'yoga', end: 'ir', yo: 'digo', 
        strong_stem: 'dij', future_stem: 'dir', part: 'dicho', 
        imp_af_tu: 'di', rule: 'e-i' 
    },
    venir: { 
        trans: 'æ¥', type: 'yoga', end: 'ir', yo: 'vengo', 
        strong_stem: 'vin', future_stem: 'vendr', 
        imp_af_tu: 'ven', rule: 'e-ie' 
    }
};

// ä¿®å¤ï¼šç»Ÿä¸€æ—¶æ€é”®åï¼Œå°†sub_imp1æ”¹ä¸ºsub_imp_raï¼Œè¡¥å……sub_imp_seå±•ç¤º
const layoutStructure = [
    { header: 'ç¬¬ä¸€æ¿å—ï¼šéäººç§°å½¢å¼', type: 'non_personal' },
    { header: 'ç¬¬äºŒæ¿å—ï¼šé™ˆè¿°å¼ (Indicativo)', subsections: [
        { title: '1. ç®€å•æ—¶æ€', tenses: ['pres', 'imp', 'pret', 'fut', 'cond'] },
        { title: '2. å¤åˆæ—¶æ€', tenses: ['comp_pres', 'comp_imp', 'comp_pret', 'comp_fut', 'comp_cond'] }
    ]},
    { header: 'ç¬¬ä¸‰æ¿å—ï¼šè™šæ‹Ÿå¼ (Subjuntivo)', subsections: [
        { title: '1. ç®€å•æ—¶æ€', tenses: ['sub_pres', 'sub_imp_ra', 'sub_imp_se', 'sub_fut'] }, // ä¿®å¤ï¼šæ·»åŠ sub_imp_se
        { title: '2. å¤åˆæ—¶æ€', tenses: ['sub_comp_pres', 'sub_comp_imp', 'sub_comp_fut'] }
    ]},
    { header: 'ç¬¬å››æ¿å—ï¼šå‘½ä»¤å¼ (Imperativo)', subsections: [
        { title: 'æŒ‡ä»¤', tenses: ['imp_af', 'imp_neg'] }
    ]}
];

const labels = {
    inf: 'åŸå½¢ (Infinitivo)', ger: 'å‰¯åŠ¨è¯ (Gerundio)', part: 'åˆ†è¯ (Participio)',
    pres: 'ç°åœ¨æ—¶', imp: 'è¿‡å»æœªå®Œæˆæ—¶', pret: 'ç®€å•è¿‡å»æ—¶', fut: 'å°†æ¥æ—¶', cond: 'æ¡ä»¶å¼',
    comp_pres: 'ç°åœ¨å®Œæˆæ—¶', comp_imp: 'è¿‡å»å®Œæˆæ—¶', comp_pret: 'å…ˆè¿‡å»æ—¶', comp_fut: 'å°†æ¥å®Œæˆæ—¶', comp_cond: 'å¤åˆæ¡ä»¶å¼',
    sub_pres: 'è™šæ‹Ÿå¼ç°åœ¨æ—¶', sub_imp_ra: 'è™šæ‹Ÿå¼è¿‡å»æœªå®Œæˆæ—¶ (-ra)', sub_imp_se: 'è™šæ‹Ÿå¼è¿‡å»æœªå®Œæˆæ—¶ (-se)', sub_fut: 'è™šæ‹Ÿå¼å°†æ¥æ—¶', // ä¿®å¤ï¼šè¡¥å……sub_imp_seæ ‡ç­¾
    sub_comp_pres: 'è™šæ‹Ÿå¼ç°åœ¨å®Œæˆæ—¶', sub_comp_imp: 'è™šæ‹Ÿå¼è¿‡å»å®Œæˆæ—¶', sub_comp_fut: 'è™šæ‹Ÿå¼å°†æ¥å®Œæˆæ—¶',
    imp_af: 'è‚¯å®šå‘½ä»¤å¼', imp_neg: 'å¦å®šå‘½ä»¤å¼'
};

/* ================= å˜ä½é€»è¾‘å¼•æ“ ================= */

function getParticiple(verb) {
    const vData = verbsDB[verb];
    if (!vData) return "Error";
    if (vData.part) return vData.part;
    // ä¿®å¤ï¼šç®€åŒ–é€»è¾‘ï¼Œä¼˜å…ˆä½¿ç”¨è§„åˆ™è¯å°¾
    return verb.slice(0, -2) + regularEndings[vData.end].part;
}

function getGerund(verb) {
    const vData = verbsDB[verb];
    if (vData.ger) return vData.ger;
    const stem = verb.slice(0,-2);
    const end = vData.end;
    if (vData.ger_stem) return vData.ger_stem + 'iendo';
    if (end === 'ir' && (vData.rule === 'e-ie' || vData.rule === 'e-i')) return stem.replace(/e(?!.*e)/, 'i') + 'iendo';
    if (end === 'ir' && vData.rule === 'o-ue') return stem.replace(/o(?!.*o)/, 'u') + 'iendo';
    if (['leer','traer','caer'].includes(verb)) return stem + 'yendo';
    return stem + regularEndings[end].ger;
}

function conjugate(verb, tense, pIdx) {
    const vData = verbsDB[verb];
    if (!vData) return '<span class="wrong-msg">æœªçŸ¥åŠ¨è¯</span>'; // ä¿®å¤ï¼šæ·»åŠ é”™è¯¯å¤„ç†
    const stem = verb.slice(0, -2);
    
    // å¤åˆæ—¶æ€
    if (tense.includes('comp_')) {
        const pp = getParticiple(verb);
        let auxKey = tense.replace('comp_', '');
        // ä¿®å¤ï¼šå¤åˆæ—¶æ€åŠ©åŠ¨è¯æ˜ å°„
        if (auxKey === 'pret') auxKey = 'pret'; 
        if (tense === 'sub_comp_pres') auxKey = 'sub_pres';
        if (tense === 'sub_comp_imp') auxKey = 'sub_imp_ra'; // ä¿®å¤ï¼šæ˜ç¡®å¤åˆè™šæ‹Ÿå¼è¿‡å»æ—¶ç”¨-raå½¢å¼
        if (tense === 'sub_comp_fut') auxKey = 'sub_fut';
        if (tense === 'comp_cond') auxKey = 'cond';
        const aux = haberForms[auxKey] ? haberForms[auxKey][pIdx] : 'é”™è¯¯'; // ä¿®å¤ï¼šæ·»åŠ åŠ©åŠ¨è¯å­˜åœ¨æ€§æ£€æŸ¥
        return `<span class="aux">${aux}</span> <span class="part">${pp}</span>`;
    }

    // å®Œå…¨ä¸è§„åˆ™ï¼šä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰forms
    if (vData.type === 'total' && vData.forms && vData.forms[tense] && vData.forms[tense][pIdx] !== undefined) {
        return `<span class="irreg">${vData.forms[tense][pIdx]}</span>`;
    }

    // ç®€å•è¿‡å»æ—¶
    if (tense === 'pret') {
        if (pIdx === 0 && vData.pret_yo) return `<span class="irreg">${vData.pret_yo}</span>`;
        if (vData.strong_stem) {
            const sStem = vData.strong_stem;
            const strongEndings = ['e', 'iste', 'o', 'imos', 'isteis', 'ieron'];
            let finalStem = sStem;
            if (verb === 'hacer' && pIdx === 2) finalStem = 'hiz';
            let suffix = strongEndings[pIdx];
            if (sStem.endsWith('j') && pIdx === 5) suffix = 'eron'; 
            return `<span class="irreg">${finalStem}</span><span class="ending">${suffix}</span>`;
        }
        if (vData.end === 'ir' && vData.type === 'stem' && (pIdx === 2 || pIdx === 5)) {
            let irStem = stem;
            if (vData.rule === 'e-ie' || vData.rule === 'e-i') irStem = stem.replace(/e(?!.*e)/, 'i');
            if (vData.rule === 'o-ue') irStem = stem.replace(/o(?!.*o)/, 'u');
            let suffix = regularEndings['ir']['pret'][pIdx];
            return `<span class="irreg">${irStem}</span><span class="ending">${suffix}</span>`;
        }
    }

    // å°†æ¥/æ¡ä»¶
    if ((tense === 'fut' || tense === 'cond') && vData.future_stem) {
        const fStem = vData.future_stem;
        const suffix = regularEndings['ar'][tense][pIdx]; 
        return `<span class="irreg">${fStem}</span><span class="ending">${suffix}</span>`;
    }

    // ä¿®å¤ï¼šè™šæ‹Ÿå¼è¿‡å»æœªå®Œæˆæ—¶(-ra/-se)å¤„ç†ï¼Œä¿®æ­£è¯å°¾é‡éŸ³
    if (tense === 'sub_imp_ra' || tense === 'sub_imp_se' || tense === 'sub_fut') {
        let pret3plRaw = conjugate(verb, 'pret', 5);
        let pret3pl = pret3plRaw.replace(/<[^>]*>/g, '');
        let base = pret3pl.slice(0, -3); 
        // ä¿®å¤ï¼šä¿®æ­£è¯å°¾é‡éŸ³ï¼Œæ·»åŠ -seå½¢å¼çš„è¯å°¾
        let endingMap = {
            'sub_imp_ra': ['ra','ras','ra','Ã¡ramos','rais','ran'], // ä¿®å¤ï¼šæ·»åŠ é‡éŸ³
            'sub_imp_se': ['se','ses','se','Ã¡semos','seis','sen'], // ä¿®å¤ï¼šæ·»åŠ -seè¯å°¾
            'sub_fut': ['re','res','re','Ã¡remos','reis','ren']
        };
        let suffix = endingMap[tense][pIdx];
        if (pIdx === 3) {
            let lastChar = base.slice(-1);
            let prevBase = base.slice(0, -1);
            if(lastChar === 'a') lastChar = 'Ã¡';
            if(lastChar === 'e') lastChar = 'Ã©';
            if(lastChar === 'i') lastChar = 'Ã­'; 
            base = prevBase + lastChar;
        }
        if (vData.strong_stem || vData.type === 'total' || (vData.end === 'ir' && vData.type === 'stem')) {
            return `<span class="irreg">${base}</span><span class="ending">${suffix}</span>`;
        }
        return `<span class="root">${base}</span><span class="ending">${suffix}</span>`;
    }

    // å‘½ä»¤å¼
    if (tense === 'imp_af') {
        // ä¿®å¤ï¼šä¼˜å…ˆæ£€æŸ¥è‡ªå®šä¹‰å‘½ä»¤å¼å½¢å¼
        if (vData.forms && vData.forms.imp_af && vData.forms.imp_af[pIdx] !== undefined) {
            return `<span class="irreg">${vData.forms.imp_af[pIdx]}</span>`;
        }
        if (pIdx === 1 && vData.imp_af_tu) return `<span class="irreg">${vData.imp_af_tu}</span>`;
        if (pIdx === 1) return conjugate(verb, 'pres', 2);
        if (pIdx === 4) { 
            let vosForm = verb.slice(0, -1) + 'd'; 
            return `<span class="root">${vosForm.slice(0,-1)}</span><span class="ending">d</span>`;
        }
        return conjugate(verb, 'sub_pres', pIdx);
    }
    // ä¿®å¤ï¼šå‘½ä»¤å¼å¦å®šå¼ - ä¿ç•™åŸè™šæ‹Ÿå¼æ ·å¼ï¼Œä¸æå–çº¯æ–‡æœ¬
    if (tense === 'imp_neg') {
        if (pIdx === 0) return ''; // Yoæ— å‘½ä»¤å¼
        const subForm = conjugate(verb, 'sub_pres', pIdx);
        return `<span class="aux">no</span> ${subForm}`;
    }

    // å¸¸è§„å˜ä½
    let suffix = regularEndings[vData.end][tense] ? regularEndings[vData.end][tense][pIdx] : '';
    if (!suffix) return '<span class="wrong-msg">æ— æ­¤å˜ä½</span>'; // ä¿®å¤ï¼šç©ºå€¼å¤„ç†
    let currStem = stem;
    let isIrreg = false;

    if (tense === 'pres' && pIdx === 0 && vData.yo) return `<span class="irreg">${vData.yo}</span>`;

    if (tense === 'sub_pres' && (vData.type === 'yoga' || vData.type === 'yo-zc')) {
        if (vData.sub_pres) return `<span class="irreg">${vData.sub_pres[pIdx]}</span>`;
        let yoForm = vData.yo;
        if (yoForm.endsWith('o')) {
            let zStem = yoForm.slice(0, -1);
            return `<span class="irreg">${zStem}</span><span class="ending">${suffix}</span>`;
        }
    }

    if (vData.type === 'stem') {
        if ((tense === 'pres' || tense === 'sub_pres') && ![3,4].includes(pIdx)) {
            if (vData.rule === 'e-ie') currStem = stem.replace(/e(?!.*e)/, 'ie');
            if (vData.rule === 'o-ue') currStem = stem.replace(/o(?!.*o)/, 'ue');
            if (vData.rule === 'u-ue') currStem = stem.replace(/u(?!.*u)/, 'ue');
            if (vData.rule === 'e-i')  currStem = stem.replace(/e(?!.*e)/, 'i');
            if (currStem !== stem) isIrreg = true;
        }
        if (tense === 'sub_pres' && [3,4].includes(pIdx) && vData.end === 'ir') {
             if (vData.rule === 'e-ie' || vData.rule === 'e-i') { currStem = stem.replace(/e(?!.*e)/, 'i'); isIrreg = true; }
             if (vData.rule === 'o-ue') { currStem = stem.replace(/o(?!.*o)/, 'u'); isIrreg = true; }
        }
    }

    if (isIrreg) return `<span class="irreg">${currStem}</span><span class="ending">${suffix}</span>`;
    return `<span class="root">${currStem}</span><span class="ending">${suffix}</span>`;
}

/* ================= é¡µé¢æ¸²æŸ“é€»è¾‘ ================= */

function renderDisplay(verb) {
    currentVerb = verb;
    const container = document.getElementById('conjugation-display');
    const vData = verbsDB[verb];
    if (!vData) { // ä¿®å¤ï¼šæœªçŸ¥åŠ¨è¯å¤„ç†
        container.innerHTML = '<div class="card"><h2>é”™è¯¯</h2><p>æœªçŸ¥åŠ¨è¯ï¼Œè¯·é€‰æ‹©åˆ—è¡¨ä¸­çš„åŠ¨è¯</p></div>';
        return;
    }
    let html = `
    <div class="card" style="border-top-color:var(--primary);">
        <h2 style="border:none; margin-bottom:5px;">${verb.toUpperCase()}</h2>
        <p style="color:#666;">å«ä¹‰: ${vData.trans}</p>
    </div>`;

    layoutStructure.forEach(block => {
        if (block.type === 'non_personal') {
            html += `<div class="card">
                <h2>${block.header}</h2>
                <div class="np-grid">
                    <div class="np-box"><span class="np-label">Infinitivo</span><span class="np-val">${verb}</span></div>
                    <div class="np-box"><span class="np-label">Gerundio</span><span class="np-val">${getGerund(verb)}</span></div>
                    <div class="np-box"><span class="np-label">Participio</span><span class="np-val">${getParticiple(verb)}</span></div>
                </div>
            </div>`;
        } else {
            html += `<div class="card"><h2>${block.header}</h2>`;
            block.subsections.forEach(sub => {
                html += `<h3>${sub.title}</h3><div class="tense-grid">`;
                sub.tenses.forEach(tense => {
                    html += `<div class="table-wrapper">
                        <div class="tense-name">${labels[tense] || tense}</div>
                        <table class="cj-table"><tbody>`;
                    pronouns.forEach((p, idx) => {
                        // é€»è¾‘ï¼šå¦‚æœæ˜¯æ‹‰ç¾æ¨¡å¼ï¼Œä¸”indexæ˜¯4(Vosotros)ï¼Œåˆ™ä¸æ¸²æŸ“æ­¤è¡Œ
                        if (isLatamMode && idx === 4) return;

                        if ((tense === 'imp_af' || tense === 'imp_neg') && idx === 0) return;
                        let res = conjugate(verb, tense, idx);
                        html += `<tr><td class="pronoun">${p}</td><td class="verb-form">${res}</td></tr>`;
                    });
                    html += `</tbody></table></div>`;
                });
                html += `</div>`;
            });
            html += `</div>`;
        }
    });

    container.innerHTML = html;
    document.querySelectorAll('.v-btn').forEach(b => b.classList.remove('active'));
    const btn = document.querySelector(`button[onclick="loadVerb('${verb}')"]`);
    if(btn) btn.classList.add('active');
}

function loadVerb(verb) { renderDisplay(verb); }

function setTab(id, el) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
    if(id === 'quiz') initQuiz();
    if(id === 'records') showRecords();
}

/* ================= æµ‹è¯•é€»è¾‘ ================= */
let qData = null;
let records = JSON.parse(localStorage.getItem('sp_ult_rec') || '[]');

function initQuiz() { loadQuestion(); }

function loadQuestion() {
    const vKeys = Object.keys(verbsDB);
    const verb = vKeys[Math.floor(Math.random() * vKeys.length)];
    // ä¿®å¤ï¼šæµ‹è¯•æ—¶æ€åŒ…å«sub_imp_raï¼Œç§»é™¤sub_imp1
    const tenses = ['pres','pret','imp','fut','cond','sub_pres','sub_imp_ra','comp_pres','comp_imp','imp_af'];
    const tense = tenses[Math.floor(Math.random() * tenses.length)];
    
    // é€»è¾‘ï¼šéšæœºæŠ½å–äººç§°
    let pIdx;
    let maxAttempts = 20; // é˜²æ­¢æ— é™å¾ªç¯
    do {
        pIdx = Math.floor(Math.random() * 6);
        // å¦‚æœæ˜¯å‘½ä»¤å¼ï¼Œä¸èƒ½æ˜¯0
        if(tense === 'imp_af' && pIdx === 0) continue;
        // å¦‚æœæ˜¯æ‹‰ç¾æ¨¡å¼ï¼Œä¸èƒ½æ˜¯4 (Vosotros)
        if(isLatamMode && pIdx === 4) continue;
        
        break; // æ‰¾åˆ°åˆé€‚çš„äººç§°
    } while (maxAttempts-- > 0);

    qData = { verb, tense, pIdx };
    
    document.getElementById('q-verb').innerText = verb.toUpperCase();
    document.getElementById('q-meta').innerText = `${labels[tense] || tense} - ${pronouns[pIdx]}`;
    document.getElementById('q-input').value = '';
    document.getElementById('q-feedback').innerText = '';
    document.getElementById('q-input').focus();
}

function checkAnswer() {
    if(!qData) return;
    const user = document.getElementById('q-input').value.trim().toLowerCase();
    const correctHtml = conjugate(qData.verb, qData.tense, qData.pIdx);
    const correct = correctHtml.replace(/<[^>]*>/g, '').toLowerCase().trim();
    
    const fb = document.getElementById('q-feedback');
    if(user === correct) {
        fb.innerHTML = '<span class="correct-msg">Â¡Correcto!</span>';
        setTimeout(loadQuestion, 1000);
    } else {
        fb.innerHTML = `<span class="wrong-msg">Error. Respuesta: ${correct}</span>`;
        saveRecord(qData, correct);
    }
}

// æ™ºèƒ½è¾“å…¥é€»è¾‘ (ä¿®å¤ï¼šè¡¥å……å¤§å†™å­—ç¬¦æ›¿æ¢)
document.getElementById('q-input').addEventListener('input', function(e) {
    const val = e.target.value;
    // æ£€æµ‹ ' + vowel çš„æ¨¡å¼ï¼ˆå¤§å°å†™éƒ½æ”¯æŒï¼‰
    if (val.endsWith("'a") || val.endsWith("'A")) { e.target.value = val.slice(0, -2) + "Ã¡"; }
    else if (val.endsWith("'e") || val.endsWith("'E")) { e.target.value = val.slice(0, -2) + "Ã©"; }
    else if (val.endsWith("'i") || val.endsWith("'I")) { e.target.value = val.slice(0, -2) + "Ã­"; }
    else if (val.endsWith("'o") || val.endsWith("'O")) { e.target.value = val.slice(0, -2) + "Ã³"; }
    else if (val.endsWith("'u") || val.endsWith("'U")) { e.target.value = val.slice(0, -2) + "Ãº"; }
    else if (val.endsWith("'n") || val.endsWith("'N")) { e.target.value = val.slice(0, -2) + "Ã±"; }
    else if (val.endsWith("u:") || val.endsWith("U:")) { e.target.value = val.slice(0, -2) + "Ã¼"; }
});

function addChar(c) { 
    const i = document.getElementById('q-input');
    i.value += c; i.focus();
}

function nextQuestion() { loadQuestion(); }
document.getElementById('q-input').addEventListener('keypress', e => { if(e.key==='Enter') checkAnswer(); });

/* ================= é”™é¢˜è®°å½• ================= */
function saveRecord(q, ans) {
    const ctx = `${pronouns[q.pIdx]} <strong>${ans}</strong> (${q.verb})`;
    records.unshift({...q, ans, ctx, time: new Date().toLocaleDateString()});
    if(records.length > 50) records.pop();
    localStorage.setItem('sp_ult_rec', JSON.stringify(records));
}

function showRecords() {
    const div = document.getElementById('records-list');
    if(records.length === 0) {
        div.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">æš‚æ— è®°å½•</div>';
        return;
    }
    let html = '';
    records.forEach(r => {
        html += `<div class="record-item">
            <div style="font-weight:bold; color:#333;">${r.verb.toUpperCase()} <span style="font-weight:normal; color:#777; font-size:0.9em;">${labels[r.tense] || r.tense}</span></div>
            <div style="margin-top:5px; background:#f5f5f5; padding:8px; border-radius:4px;">${r.ctx}</div>
        </div>`;
    });
    div.innerHTML = html;
}

function clearRecords() {
    if(confirm('ç¡®å®šæ¸…ç©º?')) {
        records = [];
        localStorage.setItem('sp_ult_rec', '[]');
        showRecords();
    }
}

// åˆå§‹åŒ–åŠ è½½
loadVerb('hablar');

</script>
</body>
</html>